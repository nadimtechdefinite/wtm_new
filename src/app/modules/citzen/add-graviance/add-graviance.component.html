<ng-container>

    <main class="pb-5" style="margin-bottom: 40px;">

        <div class="container-fluid">
            <div class="row" style="padding: 0px 10px;">
                <h3 class="main-title">Grievance Registration</h3>
            </div>
            <section class="form-card">
                <h6 class="title-label">Applicant Details</h6>
                <form [formGroup]="grievanceForm" novalidate>
                    <div class="row g-3 mb-3">

                        <!-- Name -->
                        <div class="col-md-3">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>Name</mat-label>
                                <input matInput placeholder="Enter Name" maxlength="100" formControlName="name"
                                    autocomplete="off">
                                <mat-error *ngIf="(f['name'].touched || isSubmitted) && f['name'].invalid">
                                    Name is required
                                </mat-error>
                            </mat-form-field>
                        </div>

                        <!-- Father/Husband Name -->
                        <div class="col-md-3">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>Father/Husband Name</mat-label>
                                <input matInput placeholder="Enter Father/Husband Name" maxlength="100"
                                    formControlName="fatherHusbandName">
                                <mat-error
                                    *ngIf="(f['fatherHusbandName'].touched || isSubmitted) && f['fatherHusbandName'].invalid">
                                    Father/Husband Name is required
                                </mat-error>
                            </mat-form-field>
                        </div>

                        <!-- Gender -->
                        <div class="col-md-3">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>Gender</mat-label>
                                <mat-select formControlName="gender">
                                    <mat-option value="">Select Gender</mat-option>
                                    <mat-option value="M">Male</mat-option>
                                    <mat-option value="F">Female</mat-option>
                                    <mat-option value="T">Transgender</mat-option>
                                </mat-select>
                                <mat-error *ngIf="(f['gender'].touched || isSubmitted) && f['gender'].invalid">
                                    Gender is required
                                </mat-error>
                            </mat-form-field>
                        </div>

                        <!-- Mobile -->
                        <div class="col-md-3">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>Mobile No.</mat-label>
                                <input matInput placeholder="Enter Mobile No." maxlength="10" minlength="10"
                                    formControlName="mobile" appNumberOnly>
                                <mat-error *ngIf="(f['mobile'].touched || isSubmitted) && f['mobile'].invalid">
                                    Enter valid 10-digit mobile number.
                                </mat-error>
                                <mat-error
                                    *ngIf="(f['mobile'].touched || isSubmitted) && f['mobile'].errors?.['pattern']">
                                    Mobile must be 10 digits and start with 6-9.
                                </mat-error>
                            </mat-form-field>
                        </div>

                    </div>

                    <!-- Address Section -->
                    <h6 class="title-label">Address</h6>
                    <div class="row g-3 mb-3">

                        <!-- State -->
                        <div class="col-md-3">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>State</mat-label>
                                <mat-select formControlName="stateCode" (selectionChange)="onStateChange($event)">
                                    <mat-option value="">Select State</mat-option>
                                    <mat-option *ngFor="let s of stateList" [value]="s.stateCode">{{ s.stateName
                                        }}</mat-option>
                                </mat-select>
                                <mat-error *ngIf="(f['stateCode'].touched || isSubmitted) && f['stateCode'].invalid">
                                    State is required
                                </mat-error>
                            </mat-form-field>
                        </div>

                        <!-- District -->
                        <div class="col-md-3">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>District</mat-label>
                                <mat-select formControlName="districtCode" (selectionChange)="onDistrictChange($event)">
                                    <mat-option value="">Select District</mat-option>
                                    <mat-option *ngFor="let d of districtList" [value]="d.districtCode">{{
                                        d.districtName
                                        }}</mat-option>
                                </mat-select>
                                <mat-error
                                    *ngIf="(f['districtCode'].touched || isSubmitted) && f['districtCode'].invalid">
                                    District is required
                                </mat-error>
                            </mat-form-field>
                        </div>

                        <!-- Block -->
                        <div class="col-md-3">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>Block</mat-label>
                                <mat-select formControlName="blockCode" (selectionChange)="onBlockChange($event)">
                                    <mat-option value="">Select Block</mat-option>
                                    <mat-option *ngFor="let b of blockList" [value]="b.blockCode">{{ b.blockName
                                        }}</mat-option>
                                </mat-select>
                                <mat-error *ngIf="(f['blockCode'].touched || isSubmitted) && f['blockCode'].invalid">
                                    Block is required
                                </mat-error>
                            </mat-form-field>
                        </div>

                        <!-- Gram Panchayat -->
                        <div class="col-md-3">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>Gram Panchayat</mat-label>
                                <mat-select formControlName="panchayatCode" (selectionChange)="onGpChange($event)">
                                    <mat-option value="">Select Gram Panchayat</mat-option>
                                    <mat-option *ngFor="let gp of gpList" [value]="gp.panchayatCode">{{ gp.panchayatName
                                        }}</mat-option>
                                </mat-select>
                                <mat-error
                                    *ngIf="(f['panchayatCode'].touched || isSubmitted) && f['panchayatCode'].invalid">
                                    Gram Panchayat is required
                                </mat-error>
                            </mat-form-field>
                        </div>



                        <!-- Village -->
                        <div class="col-md-3">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>Village</mat-label>
                                <mat-select formControlName="villageCode">
                                    <mat-option value="">Select village Name</mat-option>
                                    <mat-option *ngFor="let vList of villageList" [value]="vList.villageCode">{{
                                        vList.villageName
                                        }}</mat-option>
                                </mat-select>
                                <mat-error
                                    *ngIf="(f['villageCode'].touched || isSubmitted) && f['villageCode'].invalid">
                                    village Name is required
                                </mat-error>
                            </mat-form-field>
                        </div>

                        <!--pin code -->
                        <div class="col-md-3">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>Pin Code</mat-label>
                                <input matInput placeholder="Enter Pin Code" (input)="onPinInput()" maxlength="6"
                                    formControlName="pinCode" autocomplete="off">
                                <mat-error *ngIf="(f['pinCode'].touched || isSubmitted) && f['pinCode'].invalid">
                                    Name is required
                                </mat-error>
                            </mat-form-field>
                        </div>

                        <!--Address -->
                        <div class="col-md-4">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>Address</mat-label>
                                <input matInput placeholder="Enter Address" formControlName="address"
                                    autocomplete="off">
                            </mat-form-field>
                        </div>

                    </div>

                    <!-- Grievance Section -->
                    <h6 class="title-label">Registration of Grievance</h6>
                    <div class="row g-3 mb-3">

                        <!-- Ministry -->
                        <div class="col-md-6">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>Department</mat-label>
                                <mat-select formControlName="ministry" (selectionChange)="selectedMinister($event)">
                                    <mat-option value="">Select Department</mat-option>
                                    <mat-option *ngFor="let m of ministryList" [value]="m.ministryCode">
                                        {{ m.ministryName }} {{ m.ministryShortName }}
                                    </mat-option>
                                </mat-select>
                                <mat-error *ngIf="(f['ministry'].touched || isSubmitted) && f['ministry'].invalid">
                                    Ministry is required
                                </mat-error>
                            </mat-form-field>
                        </div>

                        <!-- Scheme -->
                        <div class="col-md-6">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>Scheme</mat-label>
                                <mat-select formControlName="schemeCode">
                                    <mat-option value="">Select Scheme</mat-option>
                                    <mat-option *ngFor="let s of schemeList" [value]="s.schemeCode">{{ s.schemeName
                                        }}</mat-option>
                                </mat-select>
                                <mat-error *ngIf="(f['schemeCode'].touched || isSubmitted) && f['schemeCode'].invalid">
                                    Scheme is required
                                </mat-error>
                            </mat-form-field>
                        </div>
                    </div>
                    <!-- Description -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-8">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>Description of Grievance</mat-label>
                                <textarea matInput rows="2" formControlName="Description"
                                    (input)="micActive ? null : transliterateOnType($event)"></textarea>
                                <mat-error
                                    *ngIf="(f['Description'].touched || isSubmitted) && f['Description'].invalid">
                                    <!-- Description is required (max 250 chars) -->
                                    <small class="text-muted d-block text-end">
                                        {{ grievanceForm.get('Description')?.value?.length || 5 }} / 1000
                                    </small>
                                </mat-error>
                            </mat-form-field>

                            <a routerLink="/keyboard-setting" target="_blank"
                                matTooltip="Click here to set native language">
                                How to set native language
                            </a>
                        </div>
                        <div class="col-md-3">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>Language</mat-label>
                                <mat-select formControlName="Language" (selectionChange)="onLanguageChange($event)">
                                    <mat-option value="en-IN">English</mat-option>
                                    <mat-option value="hi-IN">Hindi</mat-option>
                                    <mat-option value="bn-IN">Bengali</mat-option>
                                    <mat-option value="ta-IN">Tamil</mat-option>
                                    <mat-option value="te-IN">Telugu</mat-option>
                                    <mat-option value="gu-IN">Gujarati</mat-option>
                                    <mat-option value="ml-IN">Malayalam</mat-option>
                                    <mat-option value="mr-IN">Marathi</mat-option>
                                    <mat-option value="kn-IN">Kannada</mat-option>
                                    <mat-option value="pa-IN">Punjabi</mat-option>
                                </mat-select>

                                <mat-error *ngIf="f['Language'].touched && f['Language'].invalid">
                                    Please select a language.
                                </mat-error>
                            </mat-form-field>
                        </div>
                        <div class="col-md-1 d-flex flex-column">
                            <button type="button" class="btn w-50 mic-btn" [ngClass]="{ 'mic-active': micActive }"
                                (click)="toggleMic()" title="Voice Input">
                                <i class="fa" [ngClass]="micActive ? 'fa-microphone' : 'fa-microphone'"></i>
                                <span>{{ micActive ? '' : '' }}</span>
                                <!-- <span>{{ micActive ? ' Lis...' : '' }}</span> -->
                            </button>
                            <!-- Show message only when mic is active -->
                            <div *ngIf="micActive" class="text-danger mt-0 ms-1">
                                {{ message }}
                            </div>
                        </div>

                    </div>

                    <div class="row g-3 mb-3 align-items-center">
                        <div class="col-md-7">
                            <label>Attachment</label>

                            <div class="d-flex align-items-center gap-2">
                                <!-- Hidden file input -->
                                <input type="file" hidden #fileInput
                                    (change)="checkUpLoadedAttachmentFormat($event, '1')"
                                    accept=".jpg,.jpeg,.png,.pdf" />

                                <!-- Choose File button (show only if no file selected) -->
                                <button *ngIf="!fileName" mat-stroked-button color="primary" type="button"
                                    (click)="fileInput.click()">
                                    Choose File
                                </button>

                                <!-- File name + clear button -->
                                <ng-container *ngIf="fileName">
                                    <span class="text-truncate">{{ fileName }}</span>

                                    <!-- Clear (cross) button -->
                                    <button mat-icon-button color="warn" type="button" aria-label="Remove file"
                                        style="background-color: #ff00001f;" (click)="clearFile(fileInput)"
                                        matTooltip="Close">
                                        <mat-icon>close</mat-icon>
                                    </button>
                                    <button style="background-color: #0d5db940;" mat-icon-button color="primary"
                                        type="button" aria-label="Preview file" (click)="previewSelectedFile()"
                                        matTooltip="Close">
                                        <mat-icon>visibility</mat-icon>
                                    </button>
                                </ng-container>
                            </div>

                            <mat-hint>Only JPEG / PNG / PDF files allowed (Max 10MB).</mat-hint>
                        </div>



                        <div class="col-md-4 d-flex gap-2 captcha-area">
                            <div id="image"
                                class="captcha-box mat-elevation-z1 d-flex align-items-center justify-content-center">
                            </div>
                            <div class="captcha-refresh-button d-flex">
                                <a type="button" class="" (click)="speakCaptcha()" title="Hear Captcha">
                                    <i class="bi bi-volume-up-fill"></i>
                                </a>
                                <a mat-icon-button (click)="reload()">
                                    <mat-icon>refresh</mat-icon>
                                </a>
                            </div>
                            <mat-form-field appearance="outline" class="flex-grow-1 w-100">
                                <mat-label>Enter Captcha</mat-label>
                                <input matInput type="text" formControlName="captcha" maxlength="6">
                                <mat-error *ngIf="(f['captcha'].touched || isSubmitted) && f['captcha'].invalid">
                                    Captcha is required
                                </mat-error>
                            </mat-form-field>
                        </div>

                    </div>
                </form>
                <div class="text-center mt-3 d-flex gap-2 justify-content-center align-items-center">
                    <button mat-raised-button color="primary" class="btn-glow btn-blue" type="submit"
                        (click)="GetverifyCaptcha()">
                        Submit
                    </button>
                    <button mat-raised-button color="warn" class="btn-glow btn-red" type="reset" (click)="resetForm()">
                        Reset
                    </button>
                </div>
            </section>
        </div>

    </main>
</ng-container>
<ng-template #pdfDialog>
    <div #saveAsPdf>
        <!-- Header -->
        <div class="d-flex align-items-center header-box mb-3">
            <img src="assets/images/logo_wtm.png" style="    width: 43px;
    margin: 20px;" alt="emblem" class="logo-img me-3" />
            <div class="text-start">
                <div class="fw-bold fs-5 text-primary">Write To Rural Development Minister</div>
                <div class="fw-semibold fs-6 text-secondary">A Grievance Redressel System For Citizens</div>
            </div>
        </div>

        <mat-dialog-content>
            <!-- Card Body -->
            <div #pdfCard class="card pdf-card p-4 shadow-sm border-0 rounded-4">
                <div class="my-3">
                    <p class="fs-6 mb-2">
                        <span class="fw-bold">Dear {{ userName.toUpperCase() }},</span>
                    </p>
                    <p class="fs-6 mb-2">
                        Your grievance has been successfully registered.
                        <!-- Your grievance Id <span class="fw-bold">{{ generatedComplaintId }}</span> -->
                        It will be forwarded to the respective nodal <span class="fw-bold">{{ schemeName }}</span>.
                    </p>
                    <p class="fs-6 mb-0">
                        Kindly note down your grievance number:
                        <span class="grievance-number">{{ generatedComplaintNo }}</span> for further tracking.
                    </p>
                </div>

                <hr class="my-3" />

                <!-- Footer -->
                <div class="footer-box d-flex justify-content-between align-items-center">
                    <span class="fs-7 text-muted">
                        Report generated on: <b>{{ currentDate | date: 'dd-MMM-yyyy' }}</b>
                    </span>
                    <!-- <a href="https://write2rdminister.dord.gov.in/#/home" target="_blank" class="footer-link">
                        Visit Portal
                    </a> -->
                </div>
            </div>
        </mat-dialog-content>

        <!-- Dialog Actions -->

    </div>
    <mat-dialog-actions align="end" class="mt-3">
        <button mat-flat-button color="primary" (click)="generatePdf()">Download PDF</button>
        <button mat-stroked-button mat-dialog-close (click)="closeDialog()">Close</button>
    </mat-dialog-actions>
</ng-template>